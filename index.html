<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç”µå•†ä¼˜æƒ åˆ¸ç³»ç»Ÿæ¼”ç¤º</title>
    <!-- å¼•å…¥ Bootstrap æ ·å¼ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- å¼•å…¥ Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        body { padding: 20px; background-color: #f8f9fa; }
        .card { margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .coupon-card { border-left: 5px solid #0d6efd; transition: all 0.3s; }
        /* å·²ä½¿ç”¨çš„æ ·å¼ï¼šå˜ç° */
        .coupon-card.used { border-left-color: #6c757d; background-color: #e9ecef; opacity: 0.7; }
        .price-highlight { font-size: 1.2em; font-weight: bold; color: #d63384; }
    </style>
</head>
<body>

<div id="app" class="container">
    <h2 class="mb-4 text-center">ğŸŸï¸ ä¼˜æƒ åˆ¸ç³»ç»Ÿ - å…¨æµç¨‹æ¼”ç¤º</h2>

    <!-- 1. å…¨å±€è®¾ç½®åŒºåŸŸ -->
    <div class="card">
        <div class="card-header bg-dark text-white">ğŸ‘¤ ç”¨æˆ·ä¸ç¯å¢ƒæ¨¡æ‹Ÿ</div>
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <label class="form-label fw-bold">å½“å‰æ¨¡æ‹Ÿçš„ç”¨æˆ· ID (X-User-Id):</label>
                    <div class="input-group">
                        <span class="input-group-text">ID</span>
                        <!-- IDå˜åŒ–æ—¶è‡ªåŠ¨åˆ·æ–°åˆ—è¡¨ -->
                        <input type="number" class="form-control" v-model="currentUserId" @change="refreshAll">
                    </div>
                    <small class="text-muted">åˆ‡æ¢ ID å¯æŸ¥çœ‹ä¸åŒç”¨æˆ·çš„å¡åŒ…</small>
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-bold">ğŸ›’ æ¨¡æ‹Ÿè®¢å•æ€»é‡‘é¢ (ç”¨äºæ ¸é”€è®¡ç®—):</label>
                    <div class="input-group">
                        <span class="input-group-text">Â¥</span>
                        <input type="number" class="form-control" v-model="orderAmount" placeholder="è¾“å…¥æ¶ˆè´¹é‡‘é¢">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- 2. å•†å®¶åå°åŒºåŸŸ (å·¦ä¾§) -->
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">ğŸ› ï¸ å•†å®¶åå° - å‘æ”¾ä¼˜æƒ åˆ¸</div>
                <div class="card-body">
                    <form @submit.prevent="createCoupon">
                        <div class="mb-3">
                            <label>ä¼˜æƒ åˆ¸åç§°</label>
                            <input v-model="newCoupon.title" type="text" class="form-control" placeholder="ä¾‹å¦‚ï¼šåŒ11æ»¡å‡åˆ¸" required>
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label>ç±»å‹</label>
                                <select v-model="newCoupon.type" class="form-select">
                                    <option :value="1">æ»¡å‡åˆ¸</option>
                                    <option :value="2">æŠ˜æ‰£åˆ¸</option>
                                </select>
                            </div>
                            <div class="col-6 mb-3">
                                <label>é¢é¢/æŠ˜æ‰£</label>
                                <input v-model="newCoupon.value" type="number" step="0.01" class="form-control" placeholder="10 æˆ– 0.8">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label>é—¨æ§›é‡‘é¢</label>
                                <input v-model="newCoupon.minThreshold" type="number" class="form-control" placeholder="100">
                            </div>
                            <div class="col-6 mb-3">
                                <label>å‘æ”¾æ€»é‡</label>
                                <input v-model="newCoupon.totalStock" type="number" class="form-control" placeholder="100">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label>æ¯äººé™é¢†</label>
                            <input v-model="newCoupon.limitPerUser" type="number" class="form-control" value="1">
                        </div>
                        <button type="submit" class="btn btn-primary w-100">åˆ›å»ºå¹¶å‘å¸ƒ</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- 3. ç”¨æˆ·é¢†åˆ¸åŒºåŸŸ (ä¸­é—´) -->
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <span>ğŸ›ï¸ é¢†åˆ¸å¤§å…</span>
                    <button @click="fetchCoupons" class="btn btn-sm btn-light">åˆ·æ–°</button>
                </div>
                <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                    <div v-if="couponList.length === 0" class="text-center text-muted py-4">
                        æš‚æ— ä¼˜æƒ åˆ¸
                    </div>

                    <div v-for="coupon in couponList" :key="coupon.id" class="card coupon-card mb-3">
                        <div class="card-body p-2">
                            <h6 class="card-title">{{ coupon.title }}</h6>
                            <p class="card-text text-muted mb-1 small">
                                <span class="badge bg-info text-dark">{{ coupon.type === 1 ? 'æ»¡å‡' : 'æŠ˜æ‰£' }}</span>
                                æ»¡ {{ coupon.minThreshold }} 
                                {{ coupon.type === 1 ? 'å‡ ' + coupon.value : 'æ‰“ ' + (coupon.value*10) + ' æŠ˜' }}
                            </p>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-danger fw-bold">ä½™: {{ coupon.availableStock }}</small>
                                <button 
                                    @click="acquireCoupon(coupon.id)" 
                                    class="btn btn-sm btn-outline-success"
                                    :disabled="coupon.availableStock <= 0">
                                    {{ coupon.availableStock > 0 ? 'é¢†å–' : 'æŠ¢å…‰' }}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. æˆ‘çš„å¡åŒ… & æ ¸é”€ (å°±æ˜¯ä½ æƒ³è¦çš„çº¢è‰²åŒºåŸŸ) -->
        <div class="col-md-4">
            <div class="card h-100" style="border: 2px solid #dc3545;">
                <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                    <span>ğŸ’³ æˆ‘çš„å¡åŒ… & ä¸‹å•æ ¸é”€</span>
                    <button @click="fetchMyCoupons" class="btn btn-sm btn-light">åˆ·æ–°</button>
                </div>
                <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                    
                    <div v-if="myCoupons.length === 0" class="text-center text-muted py-4">
                        ä½ è¿˜æ²¡æœ‰é¢†å–ä»»ä½•ä¼˜æƒ åˆ¸
                    </div>

                    <div v-for="item in myCoupons" :key="item.id" 
                         class="card coupon-card mb-3"
                         :class="{ 'used': item.status !== 1 }"> <!-- å¦‚æœä¸æ˜¯æœªä½¿ç”¨çŠ¶æ€ï¼Œå˜ç° -->
                        
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between">
                                <h6 class="card-title mb-1">{{ item.template.title }}</h6>
                                <!-- çŠ¶æ€æ ‡ç­¾ -->
                                <span class="badge" 
                                      :class="item.status === 1 ? 'bg-primary' : 'bg-secondary'">
                                    {{ item.status === 1 ? 'æœªä½¿ç”¨' : (item.status === 2 ? 'å·²ä½¿ç”¨' : 'å·²è¿‡æœŸ') }}
                                </span>
                            </div>
                            
                            <div class="small text-muted mb-2">
                                æ»¡ {{ item.template.minThreshold }} 
                                {{ item.template.type === 1 ? 'å‡ ' + item.template.value : 'æ‰“ ' + (item.template.value*10) + ' æŠ˜' }}
                            </div>

                            <!-- æ ¸é”€æ“ä½œåŒº -->
                            <div v-if="item.status === 1">
                                <button @click="checkout(item.id)" class="btn btn-sm btn-danger w-100">
                                    ä½¿ç”¨æ­¤åˆ¸ä¸‹å• (è®¢å•é¢: Â¥{{ orderAmount }})
                                </button>
                            </div>
                            <div v-else class="text-center small text-muted fst-italic">
                                <hr class="my-1">
                                æ ¸é”€æ—¶é—´: {{ item.useTime ? item.useTime.replace('T', ' ').split('.')[0] : 'æœªçŸ¥' }}
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

    </div>
</div>

<script>
    const { createApp } = Vue;
    
    // âš ï¸ ç«¯å£å·ä¿æŒä½ æˆªå›¾é‡Œçš„ 8081
    const API_BASE_URL = "http://localhost:8081/api/v1"; 

    createApp({
        data() {
            return {
                currentUserId: 1001,
                orderAmount: 200, // é»˜è®¤è®¢å•é‡‘é¢
                couponList: [],   // æ‰€æœ‰çš„åˆ¸
                myCoupons: [],    // æˆ‘é¢†åˆ°çš„åˆ¸
                newCoupon: {
                    title: "åŒ11ç‰¹æƒ åˆ¸",
                    type: 1,
                    value: 10,
                    minThreshold: 100,
                    totalStock: 50,
                    limitPerUser: 1,
                    startTime: new Date().toISOString().slice(0, 19),
                    endTime: new Date(new Date().setFullYear(new Date().getFullYear() + 1)).toISOString().slice(0, 19)
                }
            }
        },
        mounted() {
            this.refreshAll();
        },
        methods: {
            // åˆ·æ–°æ‰€æœ‰æ•°æ®
            refreshAll() {
                this.fetchCoupons();
                this.fetchMyCoupons();
            },

            // 1. è·å–å¸‚åœºä¸Šçš„åˆ¸
            async fetchCoupons() {
                try {
                    const res = await fetch(`${API_BASE_URL}/admin/coupons`);
                    const result = await res.json();
                    if (result.code === 200) this.couponList = result.data;
                } catch (e) { console.error(e); }
            },

            // 2. è·å–æˆ‘çš„åˆ¸ (æ–°åŠŸèƒ½)
            async fetchMyCoupons() {
                if (!this.currentUserId) return;
                try {
                    const res = await fetch(`${API_BASE_URL}/app/my-coupons`, {
                        headers: { 'X-User-Id': this.currentUserId } // æ³¨æ„ Header è§„èŒƒ
                    });
                    const result = await res.json();
                    if (result.code === 200) {
                        // æŠŠæ–°é¢†çš„æ’åœ¨å‰é¢
                        this.myCoupons = result.data.sort((a, b) => b.id - a.id);
                    }
                } catch (e) { console.error("è·å–æˆ‘çš„ä¼˜æƒ åˆ¸å¤±è´¥", e); }
            },

            // 3. åˆ›å»ºåˆ¸
            async createCoupon() {
                try {
                    const res = await fetch(`${API_BASE_URL}/admin/coupons`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.newCoupon)
                    });
                    const result = await res.json();
                    if (result.code === 200) {
                        alert("âœ… åˆ›å»ºæˆåŠŸï¼");
                        this.fetchCoupons();
                    } else {
                        alert("âŒ " + result.message);
                    }
                } catch (e) { alert("è¯·æ±‚å¼‚å¸¸"); }
            },

            // 4. é¢†åˆ¸
            async acquireCoupon(id) {
                try {
                    const res = await fetch(`${API_BASE_URL}/app/coupons/${id}/acquire`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-User-Id': this.currentUserId // æ³¨æ„ Header è§„èŒƒ
                        }
                    });
                    const result = await res.json();
                    if (result.code === 200) {
                        alert(`ğŸ‰ æŠ¢åˆ¸æˆåŠŸï¼`);
                        this.refreshAll(); // é¢†å®Œåˆ·æ–°ä¸¤ä¸ªåˆ—è¡¨
                    } else {
                        alert("âš ï¸ " + result.message);
                    }
                } catch (e) { alert("è¯·æ±‚å¼‚å¸¸"); }
            },

            // 5. ä¸‹å•æ ¸é”€ (æ–°åŠŸèƒ½)
            async checkout(userCouponId) {
                if (!this.orderAmount || this.orderAmount <= 0) {
                    alert("è¯·è¾“å…¥è®¢å•é‡‘é¢ï¼");
                    return;
                }
                // ç¡®è®¤æ¡†
                if(!confirm(`ç¡®è®¤ä½¿ç”¨è¿™å¼ åˆ¸æ ¸é”€å—ï¼Ÿ\nè®¢å•åŸä»·: Â¥${this.orderAmount}`)) return;

                try {
                    const res = await fetch(`${API_BASE_URL}/app/checkout`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-User-Id': this.currentUserId
                        },
                        body: JSON.stringify({
                            couponId: userCouponId, // æ³¨æ„è¿™é‡Œä¼ çš„æ˜¯ user_coupon çš„ä¸»é”®ID
                            amount: this.orderAmount
                        })
                    });
                    const result = await res.json();
                    if (result.code === 200) {
                        const finalPrice = result.data;
                        const saved = (this.orderAmount - finalPrice).toFixed(2);
                        alert(`âœ… æ ¸é”€æˆåŠŸï¼\n------------------\nåŸä»·: Â¥${this.orderAmount}\nä¼˜æƒ : -Â¥${saved}\nå®ä»˜: Â¥${finalPrice}`);
                        this.fetchMyCoupons(); // åˆ·æ–°çŠ¶æ€
                    } else {
                        alert("âŒ æ ¸é”€å¤±è´¥: " + result.message);
                    }
                } catch (e) { alert("è¯·æ±‚å¼‚å¸¸"); }
            }
        }
    }).mount('#app');
</script>

</body>
</html>